---
title: "Basic Data Analysis and Plotting with the HAVEN Dataset"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include = FALSE}
library(tidyverse)
library(ggplot2)
library(rmarkdown)
library(ggpubr)
```

## Introduction
This document demonstrates basic data analysis and plotting using the HAVEN dataset in R. This file contains data on age, sex, height, weight, bmi, lesion_volume, Number of lesions, and education level.

# Load Packages and Data
First, we need to load and read the data from the CSV file.

```{r include = FALSE}
data <- read_csv("participant_data.csv")
```
If we want to find out some basic information about the data, we can display the first few rows of the data using the head function, and calculate summary statistics for each variable. The summary statistics will give us the mean, range etc for each.
```{r}
head(data)
summary(data)
```

## Data Visualization
We can also visualize the data using various plots. For example, if we wanted to understand whether people who are older have a higher lesion volume (possibly as a result of aging) we can create a scatter plot of age and Total lesion volume, and add a line of best fit.

```{r}
ggplot(data, aes(x = age, y = `lesion_volume`)) +
  geom_point(color = "darkblue") +
  geom_smooth(method = "lm", se = TRUE, color = "darkred", linetype = "solid") +
  labs(title = "Scatter plot of age and Total lesion volume",
       x = "age",
       y = "lesion_volume") +
  theme_minimal()
```

So, you can see that the older you are, the higher the total lesion volume is.

## Violin plot of Total lesion volume by sex
We can also group these results by sex, if we wanted to know whether there was a gender effect. We can do this using a boxplot, but because we are a but fancy, we can use a violin plot, a type of boxplot which looks a bit nicer.
```{r}
ggplot(data, aes(x = sex, y = `lesion_volume`)) +
  geom_violin(aes(fill = sex), scale = "area", trim = TRUE) +
  scale_fill_brewer(palette = "Dark2") +
  labs(title = "Violin plot of Total lesion volume by sex",
       x = "sex",
       y = "lesion_volume") +
  theme_minimal() +
  theme(legend.position = "none")
```
There seems to be a similar relationship between both genders, but more of a spread among Males, possibly due to the single outlier at the top. You can see this outlier in the scatter plot as well.

## height and weight by sex
If we wanted to understand whether there is a difference between the height and weight between Males and Females, we can also do this using a scatter plot:
```{r}
g <- ggplot(data, aes(x=height, y=weight, colour=sex))
g <- g + geom_point()
g
```

## Histogram of bmi
Another type of graph that we can use is a histogram. Histograms are useful if we want to understand the spread of a particular variable for different categories. For example, if we wanted to understand the distribution of bmi or age across the group.
```{r}
ggplot(data, aes(x = bmi)) +
  geom_histogram(aes(y = after_stat(density)), binwidth = 1, fill = "steelblue", color = "black") +
  geom_density(color = "darkred", linetype = "solid", linewidth = 1) +
  labs(title = "Histogram of bmi with Density Curve",
       x = "bmi",
       y = "Density") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
        axis.title.x = element_text(face = "bold"),
        axis.title.y = element_text(face = "bold"))
```

## Histogram of age
```{r}
ggplot(data, aes(x = age)) +
  geom_histogram(aes(y = after_stat(density)), binwidth = 1, fill = "steelblue", color = "black") +
  geom_density(color = "darkred", linetype = "solid", linewidth = 1) +
  labs(title = "Histogram of age with Density Curve",
       x = "age",
       y = "Density") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
        axis.title.x = element_text(face = "bold"),
        axis.title.y = element_text(face = "bold"))
```

You can see that the distribution of bmi is lower for both low and high bmi (under and overweight) and higher in the middle. This variable is said to be 'normally distributed'. More examples of normally distributed data include height and weight (which makes sense as they constitute bmi!). It makes sense that age is not normally distributed, because we only recruited those over 50.

## Basic statistics
Ok, so we have been able to visualise the data, and we have an idea of some of the trends. But how can we test whether these results are significant? Can we say that Men are statistically taller than Women? What about the relationship between Lesion Volume and age? 

Firstly, lets get some more summary statistics, this time for specific variables by themselves:
```{r}
group_by(data, sex) %>%
  summarise(
    count = n(),
    mean = mean(height, na.rm = TRUE),
    sd = sd(height, na.rm = TRUE)
  )

group_by(data, sex) %>%
  summarise(
    count = n(),
    mean = mean(weight, na.rm = TRUE),
    sd = sd(weight, na.rm = TRUE)
  )
```

## Significance testing
So we can see that Men are generally taller and weigh more than women. But is this difference significant? To find out the statistical difference between two groups we can simply run a significance test (or t-test).
```{r}
women<-data[which(data$sex=="F"),] 
men<-data[which(data$sex=="M"),] 

t.test(women$height, men$height)
t.test(women$weight, men$weight)
```
So, we can see in the p-values that there is a statistically significant difference between the height and weight between males and females. What value is used as a cut-off for significance? Why?

However in the case that we want to see whether there is a significant relationship between two continuous variables, i.e., between age and Lesion Volume across the entire group, we can run a correlation analysis. 

Correlation between Lesion Volume and age:
```{r}
# Calculate linear regression
regression <- lm(`lesion_volume` ~ age, data = data)
r_value <- cor(data$age, data$`lesion_volume`)
p_value <- summary(regression)$coefficients[2, "Pr(>|t|)"]

# Create plot
ggplot(data, aes(x = age, y = `lesion_volume`)) +
  geom_point(color = "darkblue") +
  geom_smooth(method = "lm", se = TRUE, color = "darkred", linetype = "solid") +
  labs(title = "Scatter plot of age and Total lesion volume",
       x = "age",
       y = "lesion_volume") +
  theme_minimal() +
  annotate("text", x = min(data$age), y = max(data$`lesion_volume`),
           label = paste("R = ", round(r_value, 2), "\np-value = ", format.pval(p_value, digits = 2), sep = ""),
           hjust = 0, vjust = 1)
```

So, whilst there is a significant relationship between age and Lesion Volume, we can see one or two outliers in our data. What would the data look like if we removed them? 

```{r}
# Remove 21st and 30th rows
data_removed <- data[-c(21, 30),]

# Perform linear regression
model <- lm(`lesion_volume` ~ age, data = data_removed)
p_value <- summary(model)$coefficients[2, "Pr(>|t|)"]

# Create a scatter plot
ggplot(data_removed, aes(x = age, y = `lesion_volume`)) +
  geom_point(color = "darkblue") +
  geom_smooth(method = "lm", se = TRUE, color = "darkred", linetype = "solid") +
  labs(title = "Scatter plot of age and Total lesion volume",
       x = "age",
       y = "lesion_volume") +
  scale_y_continuous(limits = c(0, 5)) +
  theme_minimal() +
  annotate("text", x = min(data_removed$age), y = 5,
           label = paste("p-value = ", format.pval(p_value, digits = 2), sep = ""),
           hjust = 0, vjust = 1)
```

So, its not as significant, but still so. Finally, we may also want to see if there is a difference between Males and Females with Lesion Volume and age. # Calculate linear regression for Males and Females separately
```{r}
# Perform linear regression for each sex
model_male <- lm(`lesion_volume` ~ age, data = data_removed[data_removed$sex == "M",])
model_female <- lm(`lesion_volume` ~ age, data = data_removed[data_removed$sex == "F",])

# Extract p-values
p_value_male <- summary(model_male)$coefficients[2, "Pr(>|t|)"]
p_value_female <- summary(model_female)$coefficients[2, "Pr(>|t|)"]

# Create a scatter plot separating Males and Females
ggplot(data_removed, aes(x = age, y = `lesion_volume`, color = sex)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, linetype = "solid") +
  labs(title = "Scatter plot of age and Total lesion volume by sex",
       x = "age",
       y = "lesion_volume") +
  scale_y_continuous(limits = c(0, 5)) +
  theme_minimal() +
  annotate("text", x = min(data_removed$age), y = 5,
           label = paste("Males: p-value = ", format.pval(p_value_male, digits = 2), "\nFemales: p-value = ", format.pval(p_value_female, digits = 2), sep = ""),
           hjust = 0, vjust = 1)
```

We can now see that there is only a significant difference in the relationship between age and total lesion volume for females, and not for males. Why do you think that this is? Regardless, by looking at the data in this way we have found something interesting (which we didn't see before) that we can subsequently look at further.

Finally, just to understand the potential impact of demographic and brain factors upon behaviour, we can look at reaction times and accuracy during the episodic memory task. 

```{r include = FALSE}
rt_data <- read_csv("rt_data.csv")
```

```{r}
# 1) Plot correct_percent against age
plot(rt_data$Age, rt_data$correct_percent, xlab = "age", ylab = "Correct %", pch = 16)

# Add a line of best fit
lm_model <- lm(rt_data$correct_percent ~ rt_data$Age)
abline(lm_model)

# Add the p-value to the plot
p_value <- summary(lm_model)$coefficients[2,4]
text(mean(rt_data$Age), mean(rt_data$correct_percent), paste0("p-value = ", round(p_value, 4)), pos = 3)

# 2) Plot correct_rt against age
plot(rt_data$Age, rt_data$correct_rt, xlab = "age", ylab = "Correct RT", pch = 16)

# Add a line of best fit
lm_model <- lm(rt_data$correct_rt ~ rt_data$Age)
abline(lm_model)

# Add the p-value to the plot
p_value <- summary(lm_model)$coefficients[2,4]
text(mean(rt_data$Age), mean(rt_data$correct_rt), paste0("p-value = ", round(p_value, 4)), pos = 3)
```

```{r}
# 3) Plot correct_percent and correct_rt against age, separated by sex with line of best fit and p-value
par(mfrow = c(1, 2))
plot(rt_data$Age[rt_data$Sex == "M"], rt_data$correct_percent[rt_data$Sex == "M"], xlab = "age", ylab = "Correct % for males", col = "blue", pch = 16)
abline(lm(rt_data$correct_percent[rt_data$Sex == "M"] ~ rt_data$Age[rt_data$Sex == "M"]), col = "blue")
pval <- summary(lm(rt_data$correct_percent[rt_data$Sex == "M"] ~ rt_data$Age[rt_data$Sex == "M"]))$coefficients[2, 4]
text(50, 100, paste("p = ", round(pval, 3)), col = "blue")

plot(rt_data$Age[rt_data$Sex == "F"], rt_data$correct_percent[rt_data$Sex == "F"], xlab = "age", ylab = "Correct % for females", col = "red", pch = 16)
abline(lm(rt_data$correct_percent[rt_data$Sex == "F"] ~ rt_data$Age[rt_data$Sex == "F"]), col = "red")
pval <- summary(lm(rt_data$correct_percent[rt_data$Sex == "F"] ~ rt_data$Age[rt_data$Sex == "F"]))$coefficients[2, 4]
text(50, 100, paste("p = ", round(pval, 3)), col = "red")
```

```{r}
# 4) Plot correct_percent against lesion_volume
plot(rt_data$lesion_volume, rt_data$correct_percent, xlab = "Lesion volume", ylab = "Correct %", pch = 16)

# Add a line of best fit
lm_model <- lm(rt_data$correct_percent ~ rt_data$lesion_volume)
abline(lm_model)

# Add the p-value to the plot
p_value <- summary(lm_model)$coefficients[2,4]
text(mean(rt_data$lesion_volume), mean(rt_data$correct_percent), paste0("p-value = ", round(p_value, 4)), pos = 3)

# 5) Plot correct_percent against lesion_number
plot(rt_data$lesion_number, rt_data$correct_percent, xlab = "Lesion number", ylab = "Correct %", pch = 16)

# Add a line of best fit
lm_model <- lm(rt_data$correct_percent ~ rt_data$lesion_number)
abline(lm_model)

# Add the p-value to the plot
p_value <- summary(lm_model)$coefficients[2,4]
text(mean(rt_data$lesion_number), mean(rt_data$correct_percent), paste0("p-value = ", round(p_value, 4)), pos = 3)

# 6) Plot correct_rt against lesion_volume
plot(rt_data$lesion_volume, rt_data$correct_rt, xlab = "Lesion volume", ylab = "Correct RT", pch = 16)

# Add a line of best fit
lm_model <- lm(rt_data$correct_rt ~ rt_data$lesion_volume)
abline(lm_model)

# Add the p-value to the plot
p_value <- summary(lm_model)$coefficients[2,4]
text(mean(rt_data$lesion_volume), mean(rt_data$correct_rt), paste0("p-value = ", round(p_value, 4)), pos = 3)

# 7) Plot correct_rt against lesion_number
plot(rt_data$lesion_number, rt_data$correct_rt, xlab = "Lesion number", ylab = "Correct RT", pch = 16)

# Add a line of best fit
lm_model <- lm(rt_data$correct_rt ~ rt_data$lesion_number)
abline(lm_model)

# Add the p-value to the plot
p_value <- summary(lm_model)$coefficients[2,4]
text(mean(rt_data$lesion_number), mean(rt_data$correct_rt), paste0("p-value = ", round(p_value, 4)), pos = 3)
```

```{r}
# 8) Plot correct_percent and correct_rt against lesion_volume and lesion_number, separated by sex with line of best fit and p-value
par(mfrow = c(2, 2))

plot(rt_data$lesion_volume[rt_data$Sex == "M"], rt_data$correct_percent[rt_data$Sex == "M"], xlab = "Lesion volume", ylab = "Correct % for males", col = "blue", pch = 16)
abline(lm(rt_data$correct_percent[rt_data$Sex == "M"] ~ rt_data$lesion_volume[rt_data$Sex == "M"]), col = "blue")
pval <- summary(lm(rt_data$correct_percent[rt_data$Sex == "M"] ~ rt_data$lesion_volume[rt_data$Sex == "M"]))$coefficients[2, 4]
text(4, 90, paste("p = ", round(pval, 3)), col = "blue")

plot(rt_data$lesion_volume[rt_data$Sex == "F"], rt_data$correct_percent[rt_data$Sex == "F"], xlab = "Lesion volume", ylab = "Correct % for females", col = "red", pch = 16)
abline(lm(rt_data$correct_percent[rt_data$Sex == "F"] ~ rt_data$lesion_volume[rt_data$Sex == "F"]), col = "red")
pval <- summary(lm(rt_data$correct_percent[rt_data$Sex == "F"] ~ rt_data$lesion_volume[rt_data$Sex == "F"]))$coefficients[2, 4]
text(4, 90, paste("p = ", round(pval, 3)), col = "red")

plot(rt_data$lesion_number[rt_data$Sex == "M"], rt_data$correct_rt[rt_data$Sex == "M"], xlab = "Lesion number", ylab = "Correct RT for males", col = "blue", pch = 16)
abline(lm(rt_data$correct_rt[rt_data$Sex == "M"] ~ rt_data$lesion_number[rt_data$Sex == "M"]), col = "blue")
pval <- summary(lm(rt_data$correct_rt[rt_data$Sex == "M"] ~ rt_data$lesion_number[rt_data$Sex == "M"]))$coefficients[2, 4]
text(12, 4, paste("p = ", round(pval, 3)), col = "blue")

plot(rt_data$lesion_number[rt_data$Sex == "F"], rt_data$correct_rt[rt_data$Sex == "F"], xlab = "Lesion number", ylab = "Correct RT for females", col = "red", pch = 16)
abline(lm(rt_data$correct_rt[rt_data$Sex == "F"] ~ rt_data$lesion_number[rt_data$Sex == "F"]), col = "red")
pval <- summary(lm(rt_data$correct_rt[rt_data$Sex == "F"] ~ rt_data$lesion_number[rt_data$Sex == "F"]))$coefficients[2, 4]
text(12, 4, paste("p = ", round(pval, 3)), col = "red")
```

## correlation analyses
```{r}
subset_male <- subset(rt_data, sex == "M")
subset_female <- subset(rt_data, sex == "F")

# Correlation between correct_percent and age (males only)
cor_result <- cor.test(subset_male$correct_percent, subset_male$age)
cat("Correlation between correct_percent and age (males only):\n")
cat(paste("Correlation coefficient: ", cor_result$estimate, "\n"))
cat(paste("p-value: ", cor_result$p.value, "\n\n"))

# Correlation between correct_percent and age (females only)
cor_result <- cor.test(subset_female$correct_percent, subset_female$age)
cat("Correlation between correct_percent and age (females only):\n")
cat(paste("Correlation coefficient: ", cor_result$estimate, "\n"))
cat(paste("p-value: ", cor_result$p.value, "\n\n"))

# Correlation between correct_percent and lesion_volume (males only)
cor_result <- cor.test(subset_male$correct_percent, subset_male$lesion_volume)
cat("Correlation between correct_percent and lesion_volume (males only):\n")
cat(paste("Correlation coefficient: ", cor_result$estimate, "\n"))
cat(paste("p-value: ", cor_result$p.value, "\n\n"))

# Correlation between correct_percent and lesion_volume (females only)
cor_result <- cor.test(subset_female$correct_percent, subset_female$lesion_volume)
cat("Correlation between correct_percent and lesion_volume (females only):\n")
cat(paste("Correlation coefficient: ", cor_result$estimate, "\n"))
cat(paste("p-value: ", cor_result$p.value, "\n\n"))

# Correlations between correct_rt and age/lesion_volume (males/females)
cor_result <- cor.test(subset_male$correct_rt, subset_male$age)
cat("Correlation between correct_rt and age (males only):\n")
cat(paste("Correlation coefficient: ", cor_result$estimate, "\n"))
cat(paste("p-value: ", cor_result$p.value, "\n\n"))

cor_result <- cor.test(subset_female$correct_rt, subset_female$age)
cat("Correlation between correct_rt and age (females only):\n")
cat(paste("Correlation coefficient: ", cor_result$estimate, "\n"))
cat(paste("p-value: ", cor_result$p.value, "\n\n"))

cor_result <- cor.test(subset_male$correct_rt, subset_male$lesion_volume)
cat("Correlation between correct_rt and lesion_volume (males only):\n")
cat(paste("Correlation coefficient: ", cor_result$estimate, "\n"))
cat(paste("p-value: ", cor_result$p.value, "\n\n"))

cor_result <- cor.test(subset_female$correct_rt, subset_female$lesion_volume)
cat("Correlation between correct_rt and lesion_volume (females only):\n")
cat(paste("Correlation coefficient: ", cor_result$estimate, "\n"))
cat(paste("p-value: ", cor_result$p.value, "\n\n"))
```
